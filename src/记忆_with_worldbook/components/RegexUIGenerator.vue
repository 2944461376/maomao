<template>
  <div class="regex-ui-generator" style="padding: 25px !important; background: #1a1a1a !important">
    <!-- æ ‡é¢˜ -->
    <div
      style="
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid rgba(102, 126, 234, 0.2);
      "
    >
      <h3 style="color: #4a9eff; margin: 0 0 10px 0; font-size: 20px; font-weight: 600">ğŸ”§ é…’é¦†æ­£åˆ™ç•Œé¢ç”Ÿæˆå™¨</h3>
      <p style="color: #888; margin: 0; font-size: 14px; line-height: 1.6">
        AI è¾…åŠ©ç”Ÿæˆé…’é¦†æ­£åˆ™æ›¿æ¢ç•Œé¢ï¼Œç”¨è‡ªç„¶è¯­è¨€æè¿°å³å¯ç”Ÿæˆå®Œæ•´çš„ HTML/CSS/JS ä»£ç 
      </p>
    </div>

    <!-- æ–°æ‰‹ä½¿ç”¨æµç¨‹ -->
    <div
      style="
        background: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #ffc107;
      "
    >
      <h4 style="color: #ffc107; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px">
        <i class="fa-solid fa-lightbulb"></i>
        æ–°æ‰‹ä½¿ç”¨æµç¨‹ï¼ˆè¶…ç®€å•ï¼ï¼‰ï¼š
      </h4>
      <ol style="margin: 0; padding-left: 20px; color: #ccc; line-height: 2">
        <li>
          <strong style="color: #fff">ç¬¬1æ­¥ï¼š</strong> è¾“å…¥è§¦å‘è¯ï¼ˆæ¯”å¦‚
          <code style="background: #1a1a1a; padding: 2px 6px; border-radius: 3px; color: #4a9eff">ã€çŠ¶æ€æ ã€‘</code>
          ï¼‰
        </li>
        <li><strong style="color: #fff">ç¬¬2æ­¥ï¼š</strong> ç”¨è‡ªç„¶è¯­è¨€æè¿°ä½ æƒ³è¦çš„ç•Œé¢ï¼ˆçœç•¥æŠ€æœ¯ç»†èŠ‚ï¼‰</li>
        <li><strong style="color: #fff">ç¬¬3æ­¥ï¼š</strong> ç‚¹å‡»"AI ç”Ÿæˆ"ï¼Œç­‰å‡ ç§’é’Ÿï¼ŒAI è‡ªåŠ¨ç”Ÿæˆä»£ç </li>
        <li>
          <strong style="color: #fff">ç¬¬4æ­¥ï¼š</strong> çœ‹å³ä¾§<strong style="color: #51cf66">å®æ—¶é¢„è§ˆ</strong
          >ï¼Œä¸æ»¡æ„å°±ç‚¹"AI ä¿®æ”¹"ç»§ç»­è°ƒæ•´
        </li>
        <li><strong style="color: #fff">ç¬¬5æ­¥ï¼š</strong> ç‚¹å‡»"å¤åˆ¶æ­£åˆ™"ï¼Œç›´æ¥ç²˜è´´åˆ°é…’é¦†æ­£åˆ™é‡Œå°±å®Œäº†ï¼</li>
        <li>
          <strong style="color: #fff">å®Œæˆï¼</strong> ç°åœ¨åœ¨èŠå¤©ä¸­è¾“å…¥
          <code style="background: #1a1a1a; padding: 2px 6px; border-radius: 3px; color: #51cf66">ã€çŠ¶æ€æ ã€‘</code>
          å°±ä¼šæ˜¾ç¤ºä½ çš„ç•Œé¢äº†ï¼
        </li>
      </ol>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸï¼šå·¦å³åˆ†æ  -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px">
      <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
      <div style="display: flex; flex-direction: column; gap: 20px">
        <!-- è§¦å‘å…³é”®è¯ -->
        <div style="background: #2a2a2a; padding: 20px; border-radius: 8px">
          <h4 style="color: #4a9eff; margin: 0 0 15px 0; font-size: 16px">
            <i class="fa-solid fa-key"></i>
            è§¦å‘å…³é”®è¯:
          </h4>
          <input
            v-model="triggerKeyword"
            type="text"
            placeholder="è¾“å…¥è§¦å‘è¯ï¼Œä¾‹å¦‚ï¼šã€å¼€åœºç™½ã€‘"
            style="
              width: 100%;
              background: #1a1a1a;
              color: #e0e0e0;
              border: 1px solid #444;
              border-radius: 4px;
              padding: 12px;
              font-size: 14px;
            "
          />
        </div>

        <!-- ç•Œé¢æè¿°ï¼ˆAI ç”Ÿæˆï¼‰ -->
        <div
          style="background: #2a2a2a; padding: 20px; border-radius: 8px; flex: 1; display: flex; flex-direction: column"
        >
          <h4 style="color: #4a9eff; margin: 0 0 15px 0; font-size: 16px">
            <i class="fa-solid fa-magic"></i>
            ç•Œé¢æè¿°ï¼ˆAI ç”Ÿæˆï¼‰:
          </h4>
          <p style="color: #888; margin: 0 0 10px 0; font-size: 13px">
            ç”¨è‡ªç„¶è¯­è¨€æè¿°ä½ æƒ³è¦çš„ç•Œé¢ï¼Œæ¯”å¦‚ï¼šä¸€ä¸ªRPGæ¸¸æˆé£æ ¼çš„çŠ¶æ€æ ï¼Œæ˜¾ç¤ºç”Ÿå‘½å€¼ã€é­”åŠ›å€¼ã€ç»éªŒå€¼...
          </p>
          <textarea
            v-model="interfaceDescription"
            placeholder="è¯¦ç»†æè¿°ä½ æƒ³è¦çš„ç•Œé¢ï¼ˆè¶Šè¯¦ç»†è¶Šå¥½ï¼‰ï¼š&#10;- è¯´æ¸…æ¥šä½ æƒ³è¦ä»€ä¹ˆåŠŸèƒ½ï¼ˆå¦‚ï¼šç”Ÿå‘½å€¼ã€é­”åŠ›å€¼ã€ç»éªŒå€¼ï¼‰&#10;- è¯´æ¸…æ¥šä½ æƒ³è¦ä»€ä¹ˆæ ·å¼ï¼ˆå¦‚ï¼šRPGæ¸¸æˆé£æ ¼ã€èµ›åšæœ‹å…‹ã€å¯çˆ±é£ç­‰ï¼‰&#10;- å¦‚æœæƒ³è¦ç‰¹æ®Šæ•ˆæœï¼ˆå¦‚ï¼šè¿›åº¦æ¡ã€åŠ¨ç”»ã€æŒ‰é’®ï¼‰ï¼Œä¹Ÿå†™æ¸…æ¥š&#10;&#10;ä¾‹å¦‚ï¼š&#10;æˆ‘æƒ³è¦ä¸€ä¸ªç°ä»£ç®€æ´é£æ ¼çš„çŠ¶æ€æ ï¼Œæ˜¾ç¤ºå½“å‰æ—¥æœŸã€æ—¶é—´ã€åœ°ç‚¹ã€å¤©æ°”æ¸©åº¦ã€‚"
            style="
              width: 100%;
              flex: 1;
              min-height: 200px;
              background: #1a1a1a;
              color: #e0e0e0;
              border: 1px solid #444;
              border-radius: 4px;
              padding: 12px;
              font-size: 14px;
              font-family: 'Consolas', monospace;
              resize: none;
              line-height: 1.6;
            "
          />

          <!-- AI ç”Ÿæˆ/ä¿®æ”¹æŒ‰é’® -->
          <div style="display: flex; gap: 12px; margin-top: 15px">
            <button
              :disabled="!triggerKeyword || !interfaceDescription || isGenerating"
              style="
                flex: 1;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s;
              "
              :style="{ opacity: !triggerKeyword || !interfaceDescription || isGenerating ? 0.5 : 1 }"
              @click="generateWithAI"
            >
              <i class="fa-solid fa-wand-magic-sparkles"></i>
              {{ isGenerating ? 'AI ç”Ÿæˆä¸­...' : generatedCode ? 'AI é‡æ–°ç”Ÿæˆ' : 'AI ç”Ÿæˆç•Œé¢' }}
            </button>
            <button
              v-if="generatedCode"
              :disabled="isModifying"
              style="
                flex: 1;
                background: #ffc107;
                color: #000;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s;
              "
              :style="{ opacity: isModifying ? 0.5 : 1 }"
              @click="showModifyDialog"
            >
              <i class="fa-solid fa-edit"></i>
              {{ isModifying ? 'ä¿®æ”¹ä¸­...' : 'AI ä¿®æ”¹ç•Œé¢' }}
            </button>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šå®æ—¶é¢„è§ˆ -->
      <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; display: flex; flex-direction: column">
        <h4 style="color: #51cf66; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px">
          <i class="fa-solid fa-eye"></i>
          å®æ—¶é¢„è§ˆ
          <span
            v-if="generatedCode"
            style="
              margin-left: auto;
              background: #51cf66;
              color: white;
              padding: 4px 12px;
              border-radius: 12px;
              font-size: 12px;
            "
            >å·²ç”Ÿæˆ</span
          >
        </h4>
        <div
          style="
            flex: 1;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
          "
        >
          <div v-if="!generatedCode" style="text-align: center; color: #666; padding: 40px">
            <i class="fa-solid fa-image" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3"></i>
            <p style="font-size: 16px; margin: 0">ç­‰å¾…ç”Ÿæˆ...</p>
            <p style="font-size: 14px; margin: 10px 0 0 0">ç‚¹å‡»"AI ç”Ÿæˆç•Œé¢"åï¼Œé¢„è§ˆå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
          </div>
          <iframe
            v-else
            ref="previewFrame"
            :srcdoc="generatedCode"
            style="width: 100%; height: 100%; border: none; background: white"
          ></iframe>
        </div>

        <!-- å¤åˆ¶æ­£åˆ™æŒ‰é’® -->
        <button
          v-if="generatedCode"
          style="
            margin-top: 15px;
            background: #51cf66;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
          "
          @click="copyRegex"
        >
          <i class="fa-solid fa-copy"></i> å¤åˆ¶æ­£åˆ™ä»£ç 
        </button>
      </div>
    </div>

    <!-- ç”Ÿæˆçš„æ­£åˆ™ä»£ç ï¼ˆå¯æŠ˜å ï¼‰ -->
    <div v-if="generatedRegex" style="background: #2a2a2a; padding: 20px; border-radius: 8px">
      <div
        style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 15px"
        @click="showCode = !showCode"
      >
        <h4 style="color: #4a9eff; margin: 0">
          <i class="fa-solid fa-code"></i>
          ç”Ÿæˆçš„æ­£åˆ™ä»£ç 
        </h4>
        <i
          :class="showCode ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down'"
          style="color: #888; transition: transform 0.3s"
        ></i>
      </div>
      <div
        v-if="showCode"
        style="
          background: #1a1a1a;
          padding: 15px;
          border-radius: 4px;
          border: 1px solid #444;
          max-height: 300px;
          overflow-y: auto;
        "
      >
        <pre
          style="
            margin: 0;
            color: #e0e0e0;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
          "
          >{{ generatedRegex }}</pre
        >
      </div>
    </div>

    <!-- AI ä¿®æ”¹å¯¹è¯æ¡† -->
    <div
      v-if="showModify"
      style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      "
      @click.self="showModify = false"
    >
      <div
        style="
          background: #2a2a2a;
          border: 2px solid #ffc107;
          border-radius: 12px;
          padding: 30px;
          max-width: 600px;
          width: 100%;
        "
        @click.stop
      >
        <h3 style="color: #ffc107; margin: 0 0 20px 0">
          <i class="fa-solid fa-edit"></i>
          AI ä¿®æ”¹ç•Œé¢
        </h3>
        <p style="color: #888; margin: 0 0 15px 0; line-height: 1.6">
          æè¿°ä½ æƒ³è¦ä¿®æ”¹çš„åœ°æ–¹ï¼ŒAI ä¼šåœ¨å½“å‰ç•Œé¢çš„åŸºç¡€ä¸Šè¿›è¡Œè°ƒæ•´ã€‚ä¾‹å¦‚ï¼š
        </p>
        <ul style="color: #888; margin: 0 0 20px 0; padding-left: 20px; line-height: 1.8">
          <li>æŠŠç”Ÿå‘½å€¼è¿›åº¦æ¡æ”¹æˆçº¢è‰²</li>
          <li>å¢åŠ ä¸€ä¸ªé‡‘å¸æ˜¾ç¤º</li>
          <li>è°ƒæ•´æ•´ä½“å¸ƒå±€ï¼Œæ”¹æˆç«–å‘æ’åˆ—</li>
          <li>æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»åæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯</li>
        </ul>
        <textarea
          v-model="modifyInstruction"
          placeholder="è¾“å…¥ä¿®æ”¹å»ºè®®..."
          style="
            width: 100%;
            min-height: 150px;
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 12px;
            font-size: 14px;
            margin-bottom: 20px;
            resize: vertical;
          "
        ></textarea>
        <div style="display: flex; gap: 12px">
          <button
            :disabled="!modifyInstruction || isModifying"
            style="
              flex: 1;
              background: #ffc107;
              color: #000;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
            "
            :style="{ opacity: !modifyInstruction || isModifying ? 0.5 : 1 }"
            @click="modifyWithAI"
          >
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            {{ isModifying ? 'ä¿®æ”¹ä¸­...' : 'ç¡®è®¤ä¿®æ”¹' }}
          </button>
          <button
            style="
              flex: 1;
              background: #666;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
            "
            @click="showModify = false"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { normalizeApiEndpoint, useSettingsStore } from '../settings';
import { copyToClipboard } from '../utils';

const settingsStore = useSettingsStore();
const settings = settingsStore.settings;

const triggerKeyword = ref('ã€å¼€åœºç™½ã€‘');
const interfaceDescription = ref('');
const generatedCode = ref('');
const generatedRegex = ref('');
const isGenerating = ref(false);
const isModifying = ref(false);
const showCode = ref(false);
const showModify = ref(false);
const modifyInstruction = ref('');
const previewFrame = ref<HTMLIFrameElement | null>(null);

// AI ç”Ÿæˆç•Œé¢ä»£ç 
const generateWithAI = async () => {
  if (!triggerKeyword.value || !interfaceDescription.value) {
    window.toastr.warning('è¯·å¡«å†™è§¦å‘å…³é”®è¯å’Œç•Œé¢æè¿°');
    return;
  }

  isGenerating.value = true;

  try {
    const prompt = `ä½ æ˜¯ä¸€ä¸ªé…’é¦†æ­£åˆ™æ›¿æ¢ä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„æè¿°ï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ HTML ç•Œé¢ä»£ç ã€‚

ç”¨æˆ·æä¾›çš„è§¦å‘å…³é”®è¯ï¼š${triggerKeyword.value}

ç”¨æˆ·çš„ç•Œé¢æè¿°ï¼š
${interfaceDescription.value}

è¯·ç”Ÿæˆå®Œæ•´çš„ HTML ä»£ç ï¼ŒåŒ…å«ï¼š
1. HTML ç»“æ„
2. å†…åµŒçš„ <style> æ ‡ç­¾ï¼ˆCSS æ ·å¼ï¼‰
3. å†…åµŒçš„ <script> æ ‡ç­¾ï¼ˆå¦‚æœéœ€è¦ JS åŠŸèƒ½ï¼‰

è¦æ±‚ï¼š
- HTML ä»£ç è¦ç¾è§‚ã€ç°ä»£åŒ–
- CSS æ ·å¼è¦ç²¾ç¾ï¼Œç¬¦åˆç”¨æˆ·æè¿°çš„é£æ ¼
- JS ä»£ç è¦ç®€æ´å®ç”¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
- æ•´ä½“ç•Œé¢è¦ç¬¦åˆç”¨æˆ·çš„æè¿°
- ä»£ç è¦å®Œæ•´å¯ç”¨ï¼Œå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ

ç›´æ¥è¾“å‡ºå®Œæ•´çš„ HTML ä»£ç ï¼Œä» <!DOCTYPE html> æˆ– <div> å¼€å§‹ï¼Œä¸è¦æœ‰å…¶ä»–è¯´æ˜æ–‡å­—ã€‚`;

    const apiUrl = normalizeApiEndpoint(settings.api_endpoint);

    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${settings.api_key}`,
      },
      body: JSON.stringify({
        model: settings.model,
        messages: [
          {
            role: 'system',
            content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‰ç«¯å¼€å‘ä¸“å®¶ï¼Œæ“…é•¿ç”Ÿæˆç¾è§‚çš„ HTML/CSS/JS ä»£ç ã€‚è¯·æ ¹æ®ç”¨æˆ·æè¿°ç”Ÿæˆå®Œæ•´çš„ç•Œé¢ä»£ç ã€‚',
          },
          { role: 'user', content: prompt },
        ],
        temperature: 0.7,
        max_tokens: 4000,
      }),
    });

    if (!response.ok) {
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
    }

    const data = await response.json();
    let result = data.choices?.[0]?.message?.content || '';

    console.log('ğŸ“ [ç•Œé¢ç”Ÿæˆ] AI åŸå§‹è¿”å›é•¿åº¦:', result.length);
    console.log('ğŸ“ [ç•Œé¢ç”Ÿæˆ] AI åŸå§‹è¿”å›å‰500å­—ç¬¦:', result.substring(0, 500));

    // ç§»é™¤å¯èƒ½çš„ markdown ä»£ç å—æ ‡è®°
    result = result
      .replace(/```html\n?/g, '')
      .replace(/```\n?/g, '')
      .trim();

    // å°è¯•æå–HTMLä»£ç ï¼ˆå¤„ç†AIæ¨ç†è¿‡ç¨‹ï¼‰
    // 1. å…ˆæŸ¥æ‰¾ <!DOCTYPE html å¼€å¤´çš„å®Œæ•´æ–‡æ¡£
    const doctypeMatch = result.match(/<!DOCTYPE html>[\s\S]*/i);
    if (doctypeMatch) {
      result = doctypeMatch[0].trim();
      console.log('âœ… [ç•Œé¢ç”Ÿæˆ] æå–åˆ°å®Œæ•´çš„HTMLæ–‡æ¡£ï¼ˆå«DOCTYPEï¼‰');
    } else {
      // 2. å¦‚æœæ²¡æœ‰DOCTYPEï¼ŒæŸ¥æ‰¾ <html å¼€å¤´çš„éƒ¨åˆ†
      const htmlMatch = result.match(/<html[\s\S]*/i);
      if (htmlMatch) {
        result = htmlMatch[0].trim();
        console.log('âœ… [ç•Œé¢ç”Ÿæˆ] æå–åˆ°HTMLæ–‡æ¡£ï¼ˆä¸å«DOCTYPEï¼‰');
      } else if (result.includes('<') && result.includes('>')) {
        // 3. å¦‚æœæ²¡æœ‰å®Œæ•´çš„htmlæ ‡ç­¾ï¼Œä½†åŒ…å«HTMLæ ‡ç­¾
        console.log('âš ï¸ [ç•Œé¢ç”Ÿæˆ] åŒ…å«HTMLæ ‡ç­¾ä½†æ ¼å¼ä¸æ ‡å‡†ï¼Œå°è¯•åŒ…è£…');
        // å°è¯•åŒ…è£…æˆå®Œæ•´æ–‡æ¡£
        if (!result.includes('<html')) {
          result = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
${result}
</body>
</html>`;
          console.log('âœ… [ç•Œé¢ç”Ÿæˆ] å·²è‡ªåŠ¨åŒ…è£…ä¸ºå®Œæ•´HTMLæ–‡æ¡£');
        }
      } else {
        // 4. å¦‚æœå®Œå…¨æ²¡æœ‰HTMLæ ‡ç­¾ï¼Œè¯´æ˜AIè¿”å›çš„æ˜¯çº¯æ–‡æœ¬æˆ–æ¨ç†è¿‡ç¨‹
        console.error('âŒ [ç•Œé¢ç”Ÿæˆ] AIæœªè¿”å›æœ‰æ•ˆçš„HTMLä»£ç ');
        console.error('AIè¿”å›å†…å®¹:', result);
        throw new Error('AIæœªè¿”å›æœ‰æ•ˆçš„HTMLä»£ç ï¼Œè¯·å°è¯•æ›´è¯¦ç»†çš„ç•Œé¢æè¿°æˆ–æ›´æ¢æ¨¡å‹');
      }
    }

    console.log('ğŸ“ [ç•Œé¢ç”Ÿæˆ] æœ€ç»ˆHTMLé•¿åº¦:', result.length);

    generatedCode.value = result;

    // ç”Ÿæˆæ­£åˆ™é…ç½®ï¼ˆç¬¦åˆé…’é¦†æ­£åˆ™æ ¼å¼ï¼‰
    const findRegex = triggerKeyword.value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regexJson = {
      id: `regex_ui_${Date.now()}`,
      scriptName: `ç•Œé¢_${triggerKeyword.value}`,
      findRegex: findRegex,
      replaceString: result,
      trimStrings: [],
      placement: [2], // AIè¾“å‡ºåå¤„ç†
      disabled: false,
      markdownOnly: true,
      promptOnly: false,
      runOnEdit: true,
      substituteRegex: 0,
      minDepth: null,
      maxDepth: null,
    };
    generatedRegex.value = JSON.stringify(regexJson, null, 2);

    window.toastr.success('AI ç”ŸæˆæˆåŠŸï¼');
  } catch (error) {
    console.error('AI ç”Ÿæˆå¤±è´¥:', error);
    window.toastr.error('AI ç”Ÿæˆå¤±è´¥: ' + (error as Error).message);
  } finally {
    isGenerating.value = false;
  }
};

// æ˜¾ç¤ºä¿®æ”¹å¯¹è¯æ¡†
const showModifyDialog = () => {
  modifyInstruction.value = '';
  showModify.value = true;
};

// AI ä¿®æ”¹ç•Œé¢ï¼ˆå¢é‡ä¿®æ”¹ï¼‰
const modifyWithAI = async () => {
  if (!modifyInstruction.value) {
    window.toastr.warning('è¯·è¾“å…¥ä¿®æ”¹å»ºè®®');
    return;
  }

  isModifying.value = true;

  try {
    // ä½¿ç”¨å¢é‡ä¿®æ”¹ï¼šåªå‘é€åŸå§‹æè¿° + ä¿®æ”¹å»ºè®®ï¼Œè®© AI é‡æ–°ç”Ÿæˆ
    const prompt = `ä½ æ˜¯ä¸€ä¸ªé…’é¦†æ­£åˆ™æ›¿æ¢ä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„ç•Œé¢æè¿°å’Œä¿®æ”¹å»ºè®®ï¼Œç”Ÿæˆå®Œæ•´çš„ HTML ç•Œé¢ä»£ç ã€‚

ç”¨æˆ·æä¾›çš„è§¦å‘å…³é”®è¯ï¼š${triggerKeyword.value}

åŸå§‹ç•Œé¢æè¿°ï¼š
${interfaceDescription.value}

ç”¨æˆ·çš„ä¿®æ”¹å»ºè®®ï¼š
${modifyInstruction.value}

è¯·æ ¹æ®åŸå§‹æè¿°å’Œä¿®æ”¹å»ºè®®ï¼Œç”Ÿæˆå®Œæ•´çš„ HTML ä»£ç ï¼ŒåŒ…å«ï¼š
1. HTML ç»“æ„
2. å†…åµŒçš„ <style> æ ‡ç­¾ï¼ˆCSS æ ·å¼ï¼‰
3. å†…åµŒçš„ <script> æ ‡ç­¾ï¼ˆå¦‚æœéœ€è¦ JS åŠŸèƒ½ï¼‰

è¦æ±‚ï¼š
- åœ¨åŸå§‹æè¿°çš„åŸºç¡€ä¸Šï¼Œåº”ç”¨ç”¨æˆ·çš„ä¿®æ”¹å»ºè®®
- HTML ä»£ç è¦ç¾è§‚ã€ç°ä»£åŒ–
- CSS æ ·å¼è¦ç²¾ç¾
- JS ä»£ç è¦ç®€æ´å®ç”¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
- ä»£ç è¦å®Œæ•´å¯ç”¨ï¼Œå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ

ç›´æ¥è¾“å‡ºå®Œæ•´çš„ HTML ä»£ç ï¼Œä» <!DOCTYPE html> æˆ– <div> å¼€å§‹ï¼Œä¸è¦æœ‰å…¶ä»–è¯´æ˜æ–‡å­—ã€‚`;

    const apiUrl = normalizeApiEndpoint(settings.api_endpoint);

    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${settings.api_key}`,
      },
      body: JSON.stringify({
        model: settings.model,
        messages: [
          {
            role: 'system',
            content:
              'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‰ç«¯å¼€å‘ä¸“å®¶ï¼Œæ“…é•¿ç”Ÿæˆå’Œä¿®æ”¹ç¾è§‚çš„ HTML/CSS/JS ä»£ç ã€‚ä½ ä¼šæ ¹æ®ç”¨æˆ·çš„æè¿°å’Œä¿®æ”¹å»ºè®®ï¼Œç”Ÿæˆå®Œæ•´çš„ç•Œé¢ä»£ç ã€‚',
          },
          { role: 'user', content: prompt },
        ],
        temperature: 0.7,
        max_tokens: 4000,
      }),
    });

    if (!response.ok) {
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
    }

    const data = await response.json();
    let result = data.choices?.[0]?.message?.content || '';

    console.log('ğŸ“ [ç•Œé¢ä¿®æ”¹] AI åŸå§‹è¿”å›é•¿åº¦:', result.length);
    console.log('ğŸ“ [ç•Œé¢ä¿®æ”¹] AI åŸå§‹è¿”å›å‰500å­—ç¬¦:', result.substring(0, 500));

    // ç§»é™¤å¯èƒ½çš„ markdown ä»£ç å—æ ‡è®°
    result = result
      .replace(/```html\n?/g, '')
      .replace(/```\n?/g, '')
      .trim();

    // å°è¯•æå–HTMLä»£ç ï¼ˆå¤„ç†AIæ¨ç†è¿‡ç¨‹ï¼‰
    // 1. å…ˆæŸ¥æ‰¾ <!DOCTYPE html å¼€å¤´çš„å®Œæ•´æ–‡æ¡£
    const doctypeMatch = result.match(/<!DOCTYPE html>[\s\S]*/i);
    if (doctypeMatch) {
      result = doctypeMatch[0].trim();
      console.log('âœ… [ç•Œé¢ä¿®æ”¹] æå–åˆ°å®Œæ•´çš„HTMLæ–‡æ¡£ï¼ˆå«DOCTYPEï¼‰');
    } else {
      // 2. å¦‚æœæ²¡æœ‰DOCTYPEï¼ŒæŸ¥æ‰¾ <html å¼€å¤´çš„éƒ¨åˆ†
      const htmlMatch = result.match(/<html[\s\S]*/i);
      if (htmlMatch) {
        result = htmlMatch[0].trim();
        console.log('âœ… [ç•Œé¢ä¿®æ”¹] æå–åˆ°HTMLæ–‡æ¡£ï¼ˆä¸å«DOCTYPEï¼‰');
      } else if (result.includes('<') && result.includes('>')) {
        // 3. å¦‚æœæ²¡æœ‰å®Œæ•´çš„htmlæ ‡ç­¾ï¼Œä½†åŒ…å«HTMLæ ‡ç­¾
        console.log('âš ï¸ [ç•Œé¢ä¿®æ”¹] åŒ…å«HTMLæ ‡ç­¾ä½†æ ¼å¼ä¸æ ‡å‡†ï¼Œå°è¯•åŒ…è£…');
        // å°è¯•åŒ…è£…æˆå®Œæ•´æ–‡æ¡£
        if (!result.includes('<html')) {
          result = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
${result}
</body>
</html>`;
          console.log('âœ… [ç•Œé¢ä¿®æ”¹] å·²è‡ªåŠ¨åŒ…è£…ä¸ºå®Œæ•´HTMLæ–‡æ¡£');
        }
      } else {
        // 4. å¦‚æœå®Œå…¨æ²¡æœ‰HTMLæ ‡ç­¾ï¼Œè¯´æ˜AIè¿”å›çš„æ˜¯çº¯æ–‡æœ¬æˆ–æ¨ç†è¿‡ç¨‹
        console.error('âŒ [ç•Œé¢ä¿®æ”¹] AIæœªè¿”å›æœ‰æ•ˆçš„HTMLä»£ç ');
        console.error('AIè¿”å›å†…å®¹:', result);
        throw new Error('AIæœªè¿”å›æœ‰æ•ˆçš„HTMLä»£ç ï¼Œè¯·å°è¯•æ›´è¯¦ç»†çš„ä¿®æ”¹å»ºè®®æˆ–æ›´æ¢æ¨¡å‹');
      }
    }

    console.log('ğŸ“ [ç•Œé¢ä¿®æ”¹] æœ€ç»ˆHTMLé•¿åº¦:', result.length);

    generatedCode.value = result;

    // æ›´æ–°æ­£åˆ™é…ç½®ï¼ˆç¬¦åˆé…’é¦†æ­£åˆ™æ ¼å¼ï¼‰
    const findRegex = triggerKeyword.value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regexJson = {
      id: `regex_ui_${Date.now()}`,
      scriptName: `ç•Œé¢_${triggerKeyword.value}`,
      findRegex: findRegex,
      replaceString: result,
      trimStrings: [],
      placement: [2], // AIè¾“å‡ºåå¤„ç†
      disabled: false,
      markdownOnly: true,
      promptOnly: false,
      runOnEdit: true,
      substituteRegex: 0,
      minDepth: null,
      maxDepth: null,
    };
    generatedRegex.value = JSON.stringify(regexJson, null, 2);

    // æ›´æ–°ç•Œé¢æè¿°ï¼ˆå°†ä¿®æ”¹å»ºè®®åˆå¹¶åˆ°åŸæè¿°ä¸­ï¼Œç”¨äºä¸‹æ¬¡ä¿®æ”¹ï¼‰
    interfaceDescription.value = `${interfaceDescription.value}\n\nã€å·²åº”ç”¨çš„ä¿®æ”¹ã€‘ï¼š\n${modifyInstruction.value}`;

    window.toastr.success('AI ä¿®æ”¹æˆåŠŸï¼');
    showModify.value = false;
  } catch (error) {
    console.error('AI ä¿®æ”¹å¤±è´¥:', error);
    window.toastr.error('AI ä¿®æ”¹å¤±è´¥: ' + (error as Error).message);
  } finally {
    isModifying.value = false;
  }
};

// å¤åˆ¶æ­£åˆ™ä»£ç 
const copyRegex = () => {
  copyToClipboard(generatedRegex.value, 'æ­£åˆ™ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
};
</script>

<style scoped>
.regex-ui-generator {
  height: 100%;
  overflow-y: auto;
}

button:disabled {
  cursor: not-allowed !important;
  opacity: 0.5 !important;
}

button:not(:disabled):hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

code {
  background: #1a1a1a;
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'Consolas', monospace;
}

pre::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

pre::-webkit-scrollbar-track {
  background: #1a1a1a;
}

pre::-webkit-scrollbar-thumb {
  background: #4a9eff;
  border-radius: 4px;
}

pre::-webkit-scrollbar-thumb:hover {
  background: #5ab0ff;
}
</style>
